
### **CookingAgent æ¶æ„è®¾è®¡æ–‡æ¡£**

**ç‰ˆæœ¬: 1.3**
**æ—¥æœŸ: 2025å¹´7æœˆ8æ—¥**

#### 1\. æ¦‚è¿°

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å‘½ä»¤è¡ŒèŠå¤©æœºå™¨äººï¼ˆChatBotï¼‰ï¼Œæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›æ™ºèƒ½åŒ–çš„èœè°±æ¨èå’Œçƒ¹é¥ªæµç¨‹è§„åˆ’ã€‚æ•´ä½“æ¶æ„é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œåˆ†ä¸º**æ•°æ®å±‚**ã€**åº”ç”¨æ ¸å¿ƒå±‚**å’Œ**è¡¨ç°å±‚**ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å†…èšã€ä½è€¦åˆå’Œå¯æ‰©å±•æ€§ã€‚

-----

#### 2\. æ¶æ„å›¾

```mermaid
graph TD
    subgraph "è¡¨ç°å±‚ (Presentation Layer)"
        A["CLI Interface <br>(Ink + React)<br><i>ç”¨æˆ·è¾“å…¥ / æ ¼å¼åŒ–è¾“å‡º</i>"]
    end

    subgraph "åº”ç”¨æ ¸å¿ƒå±‚ (Application Core)"
        subgraph "æ ¸å¿ƒå¯¹è¯å¼•æ“ (Conversation Engine)"
            B["State Manager<br><i>(å¯¹è¯çŠ¶æ€ç®¡ç†)</i>"]
            C["AI SDK Integration<br><i>(useChat, generate)</i>"]
        end

        subgraph "çŸ¥è¯†åº“ (Knowledge Base)"
            D1["Recipe Index<br><i>(recipes_index.json)</i>"]
            D2["Recipe Data<br><i>(recipes_data.json)</i>"]
        end

        subgraph "æ™ºèƒ½ä»£ç†æ¨¡å— (Agent Module)"
            E["IntentExtractor"]
            F["MenuRecommender"]
            G["ListGenerator"]
            H["WorkflowPlanner"]
        end
    end

    subgraph "LLM æœåŠ¡å±‚ (LLM Service)"
        I["LLM API"]
    end
    
    subgraph "ç¦»çº¿æ•°æ®å¤„ç†æµç¨‹"
        J["HowToCook Repo<br><i>(Markdown)</i>"] --> K("1. MDåˆ°åŸç”ŸJSONè§£æå™¨<br><i>(RecipeParser)</i>")
        K --> L{"Raw Recipes<br><i>(ä¸­é—´äº§ç‰©)</i>"}
        L --> M("2. å¢é‡å¼æ™ºèƒ½æ‰“æ ‡å™¨<br><i>(LLM-basedTagger)</i>")
        M -- "APIè°ƒç”¨" --> I
        M --> D1
        M --> D2
    end

    A -- "ç”¨æˆ·è¾“å…¥" --> C
    C -- "æ ¼å¼åŒ–è¾“å‡º" --> A

    C --> E
    C --> F
    C --> G
    C --> H

    E -- "APIè°ƒç”¨" --> I
    F -- "APIè°ƒç”¨" --> I
    H -- "APIè°ƒç”¨" --> I
    
    F -- "å€™é€‰èœå“æŸ¥è¯¢" --> D1
    F -- "è·å–è¯¦æƒ…" --> D2
    H -- "è·å–è¯¦æƒ…" --> D2

```

-----

#### 3\. æ¨¡å—è®¾è®¡

##### 3.1 æ•°æ®é¢„å¤„ç†æ¨¡å— (ç¦»çº¿)

æ­¤æ¨¡å—ä½œä¸ºç‹¬ç«‹è„šæœ¬è¿è¡Œï¼Œé‡‡ç”¨**ä¸¤é˜¶æ®µã€å¢é‡å¼**çš„å¤„ç†æµç¨‹ã€‚

  * **é˜¶æ®µä¸€ï¼šåŸç”ŸJSONç”Ÿæˆ**

      * **`RecipeParser`**:
          * **èŒè´£**: éå†æ‰€æœ‰ `.md` èœè°±æ–‡ä»¶ï¼Œä½¿ç”¨ç¡®å®šæ€§é€»è¾‘ï¼ˆå¦‚æ­£åˆ™è¡¨è¾¾å¼ï¼‰å°†å…¶è§£æä¸ºâ€œåŸç”Ÿâ€çš„ç»“æ„åŒ–JSONå¯¹è±¡ã€‚æ­¤é˜¶æ®µ**ä¸è°ƒç”¨LLM**ã€‚
          * **æ ¸å¿ƒäº§å‡º**: ä¸ºæ¯ä¸ªèœè°±ç”Ÿæˆä¸€ä¸ªåŒ…å«åŸå§‹æ–‡æœ¬å—çš„JSONå¯¹è±¡ï¼Œå¹¶è®¡ç®—å…¶å†…å®¹çš„å“ˆå¸Œå€¼ã€‚
          * **åŸç”ŸJSON Schema (ç¤ºä¾‹)**:
            ```json
            {
              "dishName": "ç³–é†‹æ’éª¨",
              "sourceFile": "dishes/meat_dish/ç³–é†‹æ’éª¨.md",
              "contentHash": "sha256_hash_string",
              "rawContent": {
                "description": "...",
                "ingredientsAndTools": "...",
                "calculation": "...",
                "steps": "- æ’éª¨ä¸å§œç‰‡æ”¾å…¥å†·æ°´ä¸­..."
              }
            }
            ```

  * **é˜¶æ®µäºŒï¼šå¢é‡å¼æ™ºèƒ½æ‰“æ ‡**

      * **`LLM-basedTagger`**:
          * **èŒè´£**: è¯»å–åŸç”ŸJSONæ•°æ®ï¼Œå¹¶ä¸å·²æœ‰çš„æœ€ç»ˆèœè°±æ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚
          * **å¢é‡é€»è¾‘**: ä»…å¯¹**æ–°å‡ºç°**çš„æˆ–`contentHash`**å·²æ”¹å˜**çš„èœè°±è°ƒç”¨LLM APIï¼Œè¿›è¡Œæ™ºèƒ½æ ‡ç­¾å’Œå…ƒæ•°æ®ç”Ÿæˆã€‚
          * **å®ç°**: è°ƒç”¨LLMï¼Œä¼ å…¥åŸç”ŸJSONä¸­çš„`dishName`å’Œ`rawContent`ï¼Œç”Ÿæˆ`tags`ç­‰å¢å¼ºæ•°æ®ã€‚**å¢åŠ Zod SchemaéªŒè¯**ï¼Œç¡®ä¿LLMè¾“å‡ºçš„å¥å£®æ€§ï¼›è‹¥éªŒè¯å¤±è´¥ï¼Œåˆ™æ ‡è®°è¯¥èœè°±å¾…å®¡æ ¸ã€‚

  * **`DatabaseBuilder`**:

      * **èŒè´£**: æ•´åˆé˜¶æ®µäºŒçš„è¾“å‡ºï¼Œç”Ÿæˆæœ€ç»ˆä¾›åº”ç”¨ä½¿ç”¨çš„ä¸¤ä¸ªæ–‡ä»¶ã€‚
      * **`recipes_index.json`**: ä¸€ä¸ªè½»é‡çº§ç´¢å¼•æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰èœå“çš„`dishName`ã€`category`ã€`difficulty`å’Œ`tags`ï¼Œç”¨äºå¿«é€Ÿç­›é€‰ã€‚
      * **`recipes_data.json`**: ä¸€ä¸ªåŒ…å«æ‰€æœ‰èœå“å®Œæ•´ä¿¡æ¯çš„é‡é‡çº§æ•°æ®æ–‡ä»¶ï¼ŒæŒ‰`dishName`ä½œä¸ºé”®è¿›è¡Œç´¢å¼•ï¼Œæ–¹ä¾¿æŒ‰éœ€æŸ¥è¯¢ã€‚
      * **æœ€ç»ˆæ•°æ® Schema (åœ¨ `recipes_data.json` ä¸­)**:
        ```json
        {
          "ç³–é†‹æ’éª¨": {
            "category": "meat_dish",
            "difficulty": 4,
            "contentHash": "sha256_hash_string",
            "tags": {
              "taste": ["é…¸", "ç”œ"],
              "cookingStyle": ["çƒ§", "ç‚¸"],
              ...
            },
            "rawIngredientsText": "...",
            "rawCalculationText": "...",
            "rawStepsText": "- æ’éª¨ä¸å§œç‰‡æ”¾å…¥å†·æ°´ä¸­..."
          },
          ...
        }
        ```

##### 3.2 åº”ç”¨æ ¸å¿ƒå±‚ (åœ¨çº¿)

  * **æ™ºèƒ½ä»£ç†æ¨¡å— (Agent Module) - æ ¸å¿ƒå˜æ›´**:
      * **`MenuRecommender`**: æ¨èé€»è¾‘ç°åœ¨åŸºäº `recipes_index.json` è¿›è¡Œå¿«é€Ÿç­›é€‰ã€‚
      * **`ListGenerator`**:
          * **èŒè´£å˜æ›´**: ä¸å†è¿›è¡ŒåŸæ–™è§£æã€‚æ¥æ”¶ç”¨æˆ·ç¡®è®¤çš„èœå•åï¼Œç›´æ¥ä» `recipes_data.json` ä¸­æå–å¹¶å‘ˆç° `rawIngredientsText` å’Œ `rawCalculationText` çš„åŸå§‹æ–‡æœ¬ã€‚
      * **`WorkflowPlanner`**:
          * **èŒè´£å˜æ›´**: æ¥æ”¶åˆ°ç¡®è®¤èœå•åï¼Œä» `recipes_data.json` ä¸­è·å–æ¯é“èœçš„ `rawStepsText`ã€‚
          * **LLMäº¤äº’**: å°†åŸå§‹çš„ã€æœªç»å¤„ç†çš„Markdownæ­¥éª¤æ–‡æœ¬ç›´æ¥ä¼ é€’ç»™LLMï¼Œè®©å…¶åœ¨**è¿è¡Œæ—¶**è¿›è¡Œè§£æã€è§„åˆ’å’Œç¼–æ’ã€‚

-----

#### 4\. LLM Prompt ä¸äº¤äº’ç­–ç•¥

æœ¬ç« èŠ‚å®šä¹‰äº†**æ™ºèƒ½ä»£ç†æ¨¡å— (Agent Module)** ä¸­å„ä¸ªå‡½æ•°ä¸ LLM æœåŠ¡å±‚äº¤äº’çš„å…·ä½“å®ç°æ–¹å¼ã€‚

##### 4.1 é€šç”¨åŸåˆ™

  * **è§’è‰²æ‰®æ¼” (Persona)**: æ¯ä¸ªä¸ LLM çš„äº¤äº’éƒ½åº”å§‹äºä¸€ä¸ªæ˜ç¡®çš„ç³»ç»Ÿæç¤ºï¼ˆSystem Promptï¼‰ï¼Œä¸ºå…¶è®¾å®šä¸€ä¸ªä¸“å®¶è§’è‰²ï¼Œå¦‚â€œç¾é£Ÿåˆ†æå¸ˆâ€ã€â€œé«˜çº§è¥å…»å¸ˆâ€ç­‰ï¼Œä»¥å¼•å¯¼å…¶ç”Ÿæˆæ›´ä¸“ä¸šã€æ›´ç¬¦åˆæœŸæœ›çš„è¾“å‡ºã€‚
  * **ç»“æ„åŒ–è¾“å…¥è¾“å‡º**: å°½å¯èƒ½ä½¿ç”¨ JSON æ ¼å¼ä¸ LLM è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œç¨‹åºçš„å¯è§£ææ€§ã€‚Vercel AI SDK çš„ `generate` é…åˆ Zod ç­‰ schema éªŒè¯åº“æ˜¯å®ç°æ­¤ç›®æ ‡çš„ç†æƒ³é€‰æ‹©ã€‚

##### 4.2 æ¨¡å—å®ç°ç»†åˆ™

###### 4.2.1 `LLM-basedTagger` (ç¦»çº¿æ•°æ®å¢å¼º)

  * **ç›®çš„**: ä»èœè°±æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ ‡ç­¾ã€‚
  * **è¾“å…¥**: `(dishName: string, rawContent: object)`
  * **System Prompt**:
    ```
    ä½ æ˜¯ä¸€ä¸ªç²¾é€šä¸­é¤çš„ç¾é£Ÿæ•°æ®åˆ†æå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„èœè°±ä¿¡æ¯ï¼Œæå–å…³é”®ç‰¹å¾ï¼Œå¹¶ä»¥ä¸¥æ ¼çš„JSONæ ¼å¼è¾“å‡ºã€‚
    ```
  * **User Prompt (ä¼ é€’ç»™ `generate` API)**:
    ```json
    {
      "task": "Extract recipe tags",
      "dishName": "{dishName}",
      "rawContent": "{rawContent}",
      "output_schema": {
        "taste": "string[] // ä» [é…¸, ç”œ, è‹¦, è¾£, å’¸, é²œ, éº», é¦™] ä¸­é€‰æ‹©",
        "cookingStyle": "string[] // ä» [ç‚’, è’¸, ç‚–, ç‚¸, å‡‰æ‹Œ, çƒ¤, çƒ§, ç„–] ä¸­é€‰æ‹©",
        "season": "string[] // ä» [æ˜¥, å¤, ç§‹, å†¬] ä¸­é€‰æ‹©",
        "suitability": "string[] // ä» [kid_friendly, pregnancy_safe] ä¸­é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºæ•°ç»„"
      }
    }
    ```
  * **é¢„æœŸè¾“å‡º**: ä¸€ä¸ªç¬¦åˆ `output_schema` çš„ JSON å¯¹è±¡ã€‚

###### 4.2.2 `extractIntent(userInput)` (åœ¨çº¿æ„å›¾æå–)

  * **ç›®çš„**: ä»ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€å¯¹è¯ä¸­è§£æå‡ºç»“æ„åŒ–çš„ç”¨é¤åå¥½ã€‚
  * **è¾“å…¥**: `(userInput: string, conversationHistory: Message[])`
  * **System Prompt**:
    ```
    ä½ æ˜¯ä¸€ä¸ªå–„äºæ²Ÿé€šã€ç»éªŒä¸°å¯Œçš„æ™ºèƒ½ç‚¹é¤å‘˜ã€‚ä½ çš„ä»»åŠ¡æ˜¯å‡†ç¡®ç†è§£é¡¾å®¢çš„éœ€æ±‚ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºç»“æ„åŒ–çš„æ•°æ®ã€‚
    ```
  * **User Prompt (ä¼ é€’ç»™ `generate` API)**:
    ```json
    {
      "task": "Extract user preferences from conversation",
      "conversation": "{conversationHistory}",
      "latest_user_message": "{userInput}",
      "output_schema": {
        "peopleCount": "number | null",
        "tastePreferences": "string[] | null",
        "ingredientExclusions": "string[] | null",
        "specialGroup": "string[] | null // ä¾‹å¦‚: ['kid', 'pregnant']",
        "maxCookingTimeMinutes": "number | null"
      }
    }
    ```
  * **é¢„æœŸè¾“å‡º**: ä¸€ä¸ªç¬¦åˆ `output_schema` çš„ JSON å¯¹è±¡ï¼Œå…¶ä¸­æœªæåŠçš„å­—æ®µä¸º `null`ã€‚

###### 4.2.3 `recommendMenu(preferences, candidateDishes)` (åœ¨çº¿èœå•æ¨è)

  * **ç›®çš„**: åŸºäºç”¨æˆ·åå¥½å’Œå€™é€‰èœå“ï¼Œç”Ÿæˆä¸€ä»½ç§‘å­¦ã€äººæ€§åŒ–çš„èœå•ã€‚
  * **è¾“å…¥**: `(preferences: object, candidateDishes: Dish[])`
  * **System Prompt**:
    ```
    ä½ æ˜¯ä¸€ä½é«˜çº§è¥å…»å¸ˆå’Œç±³å…¶æ—é¤å…çš„è¡Œæ”¿æ€»å¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®é¡¾å®¢çš„åå¥½å’Œä»Šå¤©çš„å¯é€‰èœå“ï¼Œè®¾è®¡ä¸€ä»½è¥å…»å‡è¡¡ã€é£å‘³åè°ƒçš„å®Œç¾æ™šé¤èœå•ã€‚ä½ éœ€è¦ä¸ºä½ çš„é€‰æ‹©ç»™å‡ºä»¤äººä¿¡æœçš„ç†ç”±ã€‚
    ```
  * **User Prompt (ä¼ é€’ç»™ `generate` API)**:
    ```json
    {
      "task": "Create a dinner menu",
      "userPreferences": "{preferences}",
      "availableDishes": "{candidateDishes}",
      "menuComposition": {
          "mainDishes": 2, // æ ¹æ®äººæ•°åŠ¨æ€è®¡ç®—
          "vegetableDishes": 1,
          "soup": 1
      },
      "output_schema": {
        "menu": [
          {
            "dishName": "string",
            "recommendationReason": "string"
          }
        ]
      }
    }
    ```
  * **é¢„æœŸè¾“å‡º**: ä¸€ä¸ªåŒ…å« `menu` æ•°ç»„çš„ JSON å¯¹è±¡ã€‚

###### 4.2.4 `planWorkflow(confirmedMenu)` (åœ¨çº¿æµç¨‹è§„åˆ’)

  * **ç›®çš„**: ä¸ºå¤šé“èœçš„çƒ¹é¥ªè¿‡ç¨‹åˆ¶å®šä¸€ä¸ªé«˜æ•ˆã€å¹¶è¡Œçš„æ‰§è¡Œè®¡åˆ’ã€‚
  * **è¾“å…¥**: `(confirmedMenu: {dishName: string, rawStepsText: string}[])`
  * **System Prompt**:
    ```
    ä½ æ˜¯ä¸€ä½æ•ˆç‡å¤§å¸ˆå’Œå¨æˆ¿æ€»æŒ‡æŒ¥ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ä»½èœå•çš„å¤šä¸ªçƒ¹é¥ªæµç¨‹ï¼ˆä»¥åŸå§‹Markdownæ ¼å¼æä¾›ï¼‰ï¼Œæ•´åˆæˆä¸€ä¸ªæ¸…æ™°ã€é«˜æ•ˆã€å¯æ‰§è¡Œçš„ä½œæˆ˜è®¡åˆ’ï¼Œç‰¹åˆ«è¦è€ƒè™‘åˆ°å¨æˆ¿æ–°æ‰‹å¯èƒ½ä¼šæ‰‹å¿™è„šä¹±ã€‚è¯·æ˜ç¡®æŒ‡å‡ºå¯ä»¥å¹¶è¡Œæ“ä½œçš„æ­¥éª¤ã€‚
    ```
  * **User Prompt (ä¼ é€’ç»™ `useChat` API)**:
    ```
    è¿™æ˜¯ä»Šæ™šçš„èœå•å’Œæ¯é“èœçš„åŸå§‹çƒ¹é¥ªæ­¥éª¤ï¼Œè¯·å¸®æˆ‘åˆ¶å®šä¸€ä¸ªæœ€ä¼˜çš„çƒ¹é¥ªæµç¨‹ã€‚
    èœå•è¯¦æƒ…: 
    {JSON.stringify(confirmedMenu)}

    è¯·ç›´æ¥ä»¥è‡ªç„¶è¯­è¨€è¾“å‡ºæ­¥éª¤åˆ—è¡¨ï¼Œç”¨ ğŸ•’ ç¬¦å·æ ‡æ³¨é¢„ä¼°æ—¶é—´ï¼Œç”¨ âœ¨ ç¬¦å·é«˜äº®å¹¶è¡Œæ“ä½œæç¤ºã€‚
    ```
  * **é¢„æœŸè¾“å‡º**: ä¸€æ®µæµå¼çš„ã€æ ¼å¼åŒ–çš„ Markdown æ–‡æœ¬ï¼Œä¾› `Ink` ç›´æ¥æ¸²æŸ“ã€‚

-----

#### 5\. æŠ€æœ¯é€‰å‹ç†ç”±

  * **TypeScript**: ä¸ºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘æä¾›ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§ã€‚
  * **Vercel AI SDK**: æå¤§åœ°ç®€åŒ–äº†ä¸å¤šç§ LLM åç«¯äº¤äº’çš„å¤æ‚æ€§ï¼Œå†…ç½®äº†å¯¹æµå¼å“åº”ã€å·¥å…·è°ƒç”¨ï¼ˆæœªæ¥å¯èƒ½ç”¨åˆ°ï¼‰å’Œç»“æ„åŒ–è¾“å‡ºï¼ˆå¦‚ä½¿ç”¨ Zodï¼‰çš„è‰¯å¥½æ”¯æŒã€‚
  * **Ink**: å…è®¸æˆ‘ä»¬ä½¿ç”¨å£°æ˜å¼çš„ React èŒƒå¼æ¥æ„å»ºä¸°å¯Œçš„ã€åŠ¨æ€çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œä½“éªŒè¿œè¶…ä¼ ç»Ÿçš„ `console.log`ã€‚
  * **ç¦»çº¿æ•°æ®å¤„ç†**: å°†èœè°±è§£æå’Œæ ‡ç­¾åŒ–ä½œä¸ºç¦»çº¿æ­¥éª¤ï¼Œä¿è¯äº† Agent åœ¨çº¿æœåŠ¡æ—¶çš„é«˜æ€§èƒ½æŸ¥è¯¢ï¼Œé¿å…äº†æ¯æ¬¡å¯¹è¯éƒ½å»å®æ—¶è§£æå¤§é‡æ–‡ä»¶ã€‚